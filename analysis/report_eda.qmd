---
title: "Report EDA"
author: George Whittington
date: today
date-format: long
---

```{python}
#| label: libraries
#| output: false

import polars as pl
import polars.selectors as cs
from great_tables._heading import tab_header

import numpy as np

import matplotlib.pyplot as plt
import seaborn as sns
import great_tables

from pyhere import here

#plt.style.use("ggplot")
sns.set_style("darkgrid", {"axes.facecolor": ".9"})
sns.color_palette("crest", as_cmap=True);
```

# Data

```{python}
#| label: load-data

# Baltimore Data
# RAW Data For "Extreme Values" tables and "Uncertainty" checks
baltimore_con_raw = pl.read_csv(here("data/wide/raw/baltimore_concentration_raw.csv"))
baltimore_unc_raw = pl.read_csv(here("data/wide/raw/baltimore_uncertainty_raw.csv"))

# LOGGED Data For Histograms, Heatmaps, and Pairplots
baltimore_con_log = pl.read_csv(here("data/wide/log/baltimore_concentration_log.csv"))

# LOGGED LONG Data For Faceted Plots / Uncertainty Ratios
baltimore_long = pl.read_csv(here("data/long/baltimore_long.csv"))

# Baton Rouge Data
# RAW Data For "Extreme Values" tables and "Uncertainty" checks
baton_rouge_con_raw = pl.read_csv(here("data/wide/raw/baton_rouge_concentration_raw.csv"))
baton_rouge_unc_raw = pl.read_csv(here("data/wide/raw/baton_rouge_uncertainty_raw.csv"))

# LOGGED Data For Histograms, Heatmaps, and Pairplots
baton_rouge_con_log = pl.read_csv(here("data/wide/log/baton_rouge_concentration_log.csv"))

# LOGGED LONG Data For Faceted Plots / Uncertainty Ratios
baton_rouge_long = pl.read_csv(here("data/long/baton_rouge_long.csv"))

# St. Louis Data
# RAW Data For "Extreme Values" tables and "Uncertainty" checks
st_louis_con_raw = pl.read_csv(here("data/wide/raw/st_louis_concentration_raw.csv"))
st_louis_unc_raw = pl.read_csv(here("data/wide/raw/st_louis_uncertainty_raw.csv"))

# LOGGED Data For Histograms, Heatmaps, and Pairplots
st_louis_con_log = pl.read_csv(here("data/wide/log/st_louis_concentration_log.csv"))

# LOGGED LONG Data For Faceted Plots / Uncertainty Ratios
st_louis_long = pl.read_csv(here("data/long/st_louis_long.csv"))
```

# Baltimore

## Univariate

### Extreme Values

```{python}
#| label: tbl-baltimore-extreme-values
#| tbl-cap: Top 5 Species by Max/Mean Ratio (Raw Data)

(
    baltimore_con_raw
    .unpivot(index="date", variable_name="species", value_name="concentration")
    .group_by("species")
    .agg(
        pl.col("concentration").mean().alias("mean"),
        pl.col("concentration").max().alias("max")
    )
    .with_columns(
        (pl.col("max") / pl.col("mean")).alias("max_mean_ratio")
    )
    .sort("max_mean_ratio", descending=True)
    .head(5)
    .select("species", "mean", "max", "max_mean_ratio")
    .style
    .fmt_number(cs.numeric(), decimals=4)
    .tab_header(
        title="Baltimore Extreme Value Audit",
        subtitle="Top 5 Species by Max-to-Mean Ratio"
    )
    .opt_row_striping()
)
```

### Why Log

```{python}
#| label: fig-baltimore-why-log
#| fig-cap: Distribution of PM2.5 (Raw vs Log-Transformed)

target_col = "pm2.5" 

fig, axs = plt.subplots(1, 2, figsize=(10, 5))

# Plot 1: Raw Data (Right Skewed)
sns.histplot(data=baltimore_con_raw, x=target_col, ax=axs[0], bins=30)
axs[0].set_xlabel(f"{target_col} (Raw)")
axs[0].set_title("Raw Data")

# Plot 2: Log Data (Normal-ish)
sns.histplot(data=baltimore_con_log, x=target_col, ax=axs[1], bins=30)
axs[1].set_xlabel(f"{target_col} (Log Scale)")
axs[1].set_title("Log Transformed")

fig.suptitle("Distribution of PM2.5 (Raw vs Log-Transformed)")

plt.tight_layout()
```

### Summary Statistics

```{python}
#| label: tbl-baltimore-summary
#| tbl-cap: Summary Statistics and Sparsity Check

(
    baltimore_con_raw
    .unpivot(index="date", variable_name="species", value_name="concentration")
    .group_by("species")
    .agg(
        pl.col("concentration").mean().alias("mean"),
        pl.col("concentration").median().alias("median"),
        # Calculate % zeros by taking the mean of a boolean expression (True=1, False=0)
        (pl.col("concentration") == 0).mean().alias("pct_zeros")
    )
    .sort("mean", descending=True)
    .head(10)
    .with_columns(
        # Optional: formatting for display (or handle in style)
        pl.col("pct_zeros")
    )
    .style
    .tab_header("Summary Statistics and Sparsity Check")
    .fmt_number(columns=["mean", "median"], decimals=4)
    .fmt_percent(columns=["pct_zeros"], decimals=1)
    .opt_row_striping()
)
```

## Reliability

### Uncertainty Ratio

```{python}
#| label: fig-baltimore-uncertainty
#| fig-cap: Distribution of Uncertainty Ratios (Sigma / Concentration)

# Filter out extreme ratios (>1.0) just for plotting clarity
plot_data = (
    baltimore_long
    .filter(pl.col("uncertainty_ratio_raw") < 1.0)
    .to_pandas()
)

plt.figure(figsize=(8, 10))
sns.boxplot(
    data=plot_data,
    x="uncertainty_ratio_raw",
    y="species",
    orient="h",
    fliersize=1,
    linewidth=0.8
)

plt.title("Baltimore: Sensor Reliability Audit")
plt.xlabel("Uncertainty Ratio (Uncertainty / Concentration)")
plt.axvline(x=0.2, color='r', linestyle='--', alpha=0.5, label="20% Error Threshold")
plt.legend(loc="lower right")
```

## Multivariate

### Correlation Heatmap

```{python}
#| label: fig-baltimore-heatmap
#| fig-cap: Correlation Matrix of Key Species (Log Transformed)

# 1. Calculate Correlation on LOG data
# Select only numeric columns, drop date
corr_matrix = (
    baltimore_con_log
    .select(cs.numeric())
    .to_pandas()
    .corr()
)

# 2. Plot
plt.figure(figsize=(12, 10))
sns.heatmap(
    corr_matrix,
    cmap='RdBu_r', # Red = Positive Correlation (Moving Together)
    center=0,
    square=True,
    cbar_kws={"shrink": .5}
)

plt.title("Baltimore: Species Correlation Matrix")
```

### Pairwise Scatter

```{python}
#| label: fig-baltimore-pairs
#| fig-cap: Pairwise Relationships of Top Correlated Species

# Select a few known related species (e.g., combustion markers)
# You can adjust these names based on what you see in the heatmap
target_species = ["elemental_carbon", "organic_carbon", "sulfate", "ammonium_ion", "pm2.5"]

# Filter to existing columns just in case
existing_species = [c for c in target_species if c in baltimore_con_log.columns]

sns.pairplot(
    baltimore_con_log.select(existing_species).to_pandas(),
    plot_kws={'alpha': 0.5, 's': 10},
    diag_kind='kde'
)

plt.suptitle("Baltimore: Combustion & Secondary Aerosol Markers", y=1.02)
```

## Temporal

### Time Series Trends

```{python}
#| label: fig-baltimore-time
#| fig-cap: Temporal Trends of PM2.5 (Log Scale)

plt.figure(figsize=(12, 5))

sns.lineplot(
    data=baltimore_con_log.to_pandas(),
    x="date",
    y="pm2.5",
    alpha=0.7
)

plt.title("Baltimore: PM2.5 Time Series (Log Scale)")
plt.ylabel("Log(Concentration + 1)")
plt.xlabel("Date")
```

# Baton Rouge 

## Univariate

### Extreme Values

```{python}
#| label: tbl-baton-rouge-extreme-values
#| tbl-cap: Top 5 Species by Max/Mean Ratio (Raw Data)

(
    baton_rouge_con_raw
    .unpivot(index="date", variable_name="species", value_name="concentration")
    .group_by("species")
    .agg(
        pl.col("concentration").mean().alias("mean"),
        pl.col("concentration").max().alias("max")
    )
    .with_columns(
        (pl.col("max") / pl.col("mean")).alias("max_mean_ratio")
    )
    .sort("max_mean_ratio", descending=True)
    .head(5)
    .select("species", "mean", "max", "max_mean_ratio")
    .style
    .fmt_number(cs.numeric(), decimals=4)
    .tab_header(
        title="Baton Rouge Extreme Value Audit",
        subtitle="Top 5 Species by Max-to-Mean Ratio"
    )
    .opt_row_striping()
)
```

### Why Log

```{python}

```

### Summary Statistics

```{python}

```

## Reliability

### Uncertainty Ratio

```{python}

```

## Multivariate

### Correlation Heatmap

```{python}

```

### Pairwise Scatter

```{python}

```

## Temporal

### Time Series Trends

```{python}

```

# St. Louis

## Univariate

### Extreme Values

```{python}

```

### Why Log

```{python}

```

### Summary Statistics

```{python}

```

## Reliability

### Uncertainty Ratio

```{python}

```

## Multivariate

### Correlation Heatmap

```{python}

```

### Pairwise Scatter

```{python}

```

## Temporal

### Time Series Trends

```{python}

```