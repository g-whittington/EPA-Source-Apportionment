---
title: "Report EDA"
author: George Whittington
date: today
date-format: long
---

```{python}
#| label: libraries
#| output: false

import polars as pl
import polars.selectors as cs

import numpy as np

import matplotlib.pyplot as plt
import seaborn as sns
import great_tables

from pyhere import here

from analysis.helper import * 

#plt.style.use("ggplot")
sns.set_style("darkgrid", {"axes.facecolor": ".9"})
sns.color_palette("crest", as_cmap=True);
```

# Data

```{python}
#| label: load-data

# Baltimore Data
# RAW Data For "Extreme Values" tables and "Uncertainty" checks
baltimore_con_raw = pl.read_csv(here("data/wide/raw/baltimore_concentration_raw.csv"))
baltimore_unc_raw = pl.read_csv(here("data/wide/raw/baltimore_uncertainty_raw.csv"))

# LOGGED Data For Histograms, Heatmaps, and Pairplots
baltimore_con_log = pl.read_csv(here("data/wide/log/baltimore_concentration_log.csv"))

# LOGGED LONG Data For Faceted Plots / Uncertainty Ratios
baltimore_long = pl.read_csv(here("data/long/baltimore_long.csv"))

# Baton Rouge Data
# RAW Data For "Extreme Values" tables and "Uncertainty" checks
baton_rouge_con_raw = pl.read_csv(here("data/wide/raw/baton_rouge_concentration_raw.csv"))
baton_rouge_unc_raw = pl.read_csv(here("data/wide/raw/baton_rouge_uncertainty_raw.csv"))

# LOGGED Data For Histograms, Heatmaps, and Pairplots
baton_rouge_con_log = pl.read_csv(here("data/wide/log/baton_rouge_concentration_log.csv"))

# LOGGED LONG Data For Faceted Plots / Uncertainty Ratios
baton_rouge_long = pl.read_csv(here("data/long/baton_rouge_long.csv"))

# St. Louis Data
# RAW Data For "Extreme Values" tables and "Uncertainty" checks
st_louis_con_raw = pl.read_csv(here("data/wide/raw/st_louis_concentration_raw.csv"))
st_louis_unc_raw = pl.read_csv(here("data/wide/raw/st_louis_uncertainty_raw.csv"))

# LOGGED Data For Histograms, Heatmaps, and Pairplots
st_louis_con_log = pl.read_csv(here("data/wide/log/st_louis_concentration_log.csv"))

# LOGGED LONG Data For Faceted Plots / Uncertainty Ratios
st_louis_long = pl.read_csv(here("data/long/st_louis_long.csv"))
```

# Baltimore

## Univariate

### Extreme Values

```{python}
#| label: tbl-baltimore-extreme-values
#| tbl-cap: Top 5 Species by Max/Mean Ratio (Raw Data)

extreme_values_table(baltimore_con_raw, "Baltimore")
```

### Why Log

```{python}
#| label: fig-baltimore-why-log
#| fig-cap: Distribution of PM2.5 (Raw vs Log-Transformed)

log_comparison_plot(baltimore_con_raw, baltimore_con_log, target_col = "pm2.5")
```

### Summary Statistics

```{python}
#| label: tbl-baltimore-summary
#| tbl-cap: Summary Statistics and Sparsity Check

summary_statistics(baltimore_con_raw)
```

## Reliability

### Uncertainty Ratio

```{python}
#| label: fig-baltimore-uncertainty
#| fig-cap: Distribution of Uncertainty Ratios (Sigma / Concentration)

uncertainty_ratio_plot(baltimore_long, "Baltimore")
```

## Multivariate

### Correlation Heatmap

```{python}
#| label: fig-baltimore-heatmap-5
#| fig-cap: Correlation Matrix of Key Species (Log Transformed)

correlation_heatmap_plot(baltimore_con_log, "Baltimore", 5)
```

```{python}
#| label: fig-baltimore-heatmap-13
#| fig-cap: Correlation Matrix of Key Species (Log Transformed)

correlation_heatmap_plot(baltimore_con_log, "Baltimore", 13)
```

### Pairwise Scatter

```{python}
#| label: fig-baltimore-pairs
#| fig-cap: Pairwise Relationships of Top Correlated Species

pairwise_scatter_plot(
    baltimore_con_log,
    "Baltimore: Combustion & Secondary Aerosol Markers",
    ["elemental_carbon", "organic_carbon", "sulfate", "ammonium_ion", "pm2.5"],
)
```

## Temporal

### Time Series Trends

```{python}
#| label: fig-baltimore-time
#| fig-cap: Temporal Trends of PM2.5 (Log Scale)

time_series_plot(
    baltimore_con_log,
    "pm2.5",
    "Baltimore: PM2.5 Time Series (Log Scale)"
)
```

# Baton Rouge 

## Univariate

### Extreme Values

```{python}
#| label: tbl-baton-rouge-extreme-values
#| tbl-cap: Top 5 Species by Max/Mean Ratio (Raw Data)

extreme_values_table(baton_rouge_con_raw, "Baton Rouge")
```

### Why Log

```{python}
#| label: fig-baton-rouge-why-log
#| fig-cap: Distribution of TNMOC (Raw vs Log-Transformed)

log_comparison_plot(baton_rouge_con_raw, baton_rouge_con_log, target_col = "tnmoc")
```

### Summary Statistics

```{python}
#| label: tbl-baton-rouge-summary
#| tbl-cap: Summary Statistics and Sparsity Check

summary_statistics(baton_rouge_con_raw)
```

## Reliability

### Uncertainty Ratio

```{python}
#| label: fig-baton-rouge-uncertainty
#| fig-cap: Distribution of Uncertainty Ratios (Sigma / Concentration)

uncertainty_ratio_plot(baton_rouge_long, "Baton Rouge")
```

## Multivariate

### Correlation Heatmap

```{python}
#| label: fig-baton-rouge-heatmap-5
#| fig-cap: Correlation Matrix of Key Species (Log Transformed)

correlation_heatmap_plot(baton_rouge_con_log, "Baton Rouge", 5)
```

```{python}
#| label: fig-baton-rouge-heatmap-full
#| fig-cap: Correlation Matrix of Key Species (Log Transformed)

correlation_heatmap_plot(baton_rouge_con_log, "Baton Rouge")
```

### Pairwise Scatter

```{python}
#| label: fig-baton-rouge-pairs
#| fig-cap: Pairwise Relationships of Top Correlated Species

pairwise_scatter_plot(
    baton_rouge_con_log,
    "Baton Rouge: BTEX & TNMOC (Refinery Markers)",
    target_species = [
        "benzene", 
        "toluene", 
        "ethylbenzene", 
        "m_p_xylene", 
        "o-xylene", 
        "tnmoc"
    ]
)
```

## Temporal

### Time Series Trends

```{python}
#| label: fig-baton-rouge-time
#| fig-cap: Temporal Trends of TNMOC (Log Scale)

time_series_plot(
    baton_rouge_con_log,
    "tnmoc",
    "Baton Rouge: TNMOC Time Series (Log Scale)"
)
```

# St. Louis

## Univariate

### Extreme Values

```{python}
#| label: tbl-st-louis-extreme-values
#| tbl-cap: Top 5 Species by Max/Mean Ratio (Raw Data)

extreme_values_table(st_louis_con_raw, "St. Louis")
```

### Why Log

```{python}
#| label: fig-st-louis-why-log
#| fig-cap: Distribution of PM2.5 (Raw vs Log-Transformed)

log_comparison_plot(st_louis_con_raw, st_louis_con_log, target_col = "pm2.5")
```

### Summary Statistics

```{python}
#| label: tbl-st-louis-summary
#| tbl-cap: Summary Statistics and Sparsity Check

summary_statistics(st_louis_con_raw)
```

## Reliability

### Uncertainty Ratio

```{python}
#| label: fig-st-louis-uncertainty
#| fig-cap: Distribution of Uncertainty Ratios (Sigma / Concentration)

uncertainty_ratio_plot(st_louis_long, "St. Louis")
```

## Multivariate

### Correlation Heatmap

```{python}
#| label: fig-st-louis-heatmap
#| fig-cap: Correlation Matrix of Key Species (Log Transformed)

correlation_heatmap_plot(st_louis_con_log, "St. Louis", num_values=13)
```

### Pairwise Scatter

```{python}
#| label: fig-st-louis-pairs
#| fig-cap: Pairwise Relationships of Top Correlated Species

pairwise_scatter_plot(
    st_louis_con_log,
   "St. Louis: Major PM Constituents",
    target_species = [
        "pm2.5",
        "sulfate",
        "total_nitrate",
        "organic_carbon", 
        "elemental_carbon"
    ]
)
```

## Temporal

### Time Series Trends

```{python}
#| label: fig-st-louis-time
#| fig-cap: Temporal Trends of PM2.5 (Log Scale)

time_series_plot(
    st_louis_con_log,
    "pm2.5",
    "St. Louis: PM2.5 Time Series (Log Scale)"
)
```